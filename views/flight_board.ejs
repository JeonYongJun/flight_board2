<!DOCTYPE html>
<meta charset="utf-8">
<html>
	<head>
  <% include ./head.ejs %>
  <script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
	<script type="text/javascript" src="/javascripts/board_lib.js"></script>
	<script type="text/javascript" src="/javascripts/board_plot.js"></script>
	<link href="/stylesheets/board.css" rel="stylesheet" type="text/css"></link>
	<script>
		function init_flight_info(){
			d3.select('#flight_info').append('p').attr('id','information');
      d3.select('#flight_info').append('p').attr('id','add_work');
      d3.select('#add_work').html(`정비사 추가 => 정비사 1:
      <input type="text" name="worker1" id="job_worker1" placeholder="받을 정비사"> ~ 정비사 2:
      <input type="text" name="worker2" id="job_worker2" placeholder="보낼 정비사">
      <button id="info_close">닫기</button>
      <button id="worker_add">추가</button>`);

			// Flight detail info window
      d3.select('#info_close').on('click',function(){
        d3.select("#flight_info").attr("class","info_hidden");
      });
			// process for adding workers
      d3.select('#worker_add').on('click',function(){
        var worker1 = d3.select('#job_worker1').property('value');
        d3.select('#job_worker1').property('value','');
				var box_g = d3.select(selected_box.node().parentNode);
        if(worker1 != ''){
          //draw_text(box_g,-10,-10,worker1)
          //.attr("font-size","14").attr("font-weight","10");
					box_g.select('#worker1').text(worker1);
        }
        var worker2 = d3.select('#job_worker2').property('value');
        d3.select('#job_worker2').property('value','');
        if(worker2 != ''){
          //draw_text(box_g,selected_box.attr("width")-30,-10,worker2)
          //.attr("font-size","14").attr("font-weight","10");
					box_g.select('#worker2').text(worker2);
        }
        d3.select("#flight_info").attr("class","info_hidden");
      });
		}

		function init_controls(){
			// initialize control
      var station_list = ['ALL','GMP','ICN','CJU','CJJ','KUV','PUS']
      for(station in station_list){
      	d3.select('#station').append('option')
          .attr('value',station_list[station]).text(station_list[station]);
      }
      var today = yyyymmdd(new Date());
      d3.select('#log_date').property('value',today);
      d3.select('#station').property('value','GMP');

			// event for show_list button
			d3.select('#show_list').property('disabled',false);
			d3.select('#show_list').on('click',()=>{
				d3.select('#show_list').property('disabled',true);
				var sel_date = d3.select('#log_date').property('value');
				var sel_station = d3.select('#station').property('value');
				var json_url = '/flight_board/plan/'+sel_date+'/'+sel_station;
				d3.json(json_url,(err,data)=>{
					//console.log(data);
					if(err){
						console.log(err);
						//console.log(data);
						alert('Server Internal Error, please email to system administrator!')
					}else{
						//console.log(data.plan);
						draw_plot(sel_date,sel_station,data.plan.recordset);
					}
				});
				d3.select('#show_list').property('disabled',false);
			});
			// 스케줄 데이터 업데이트
			d3.select('#update_list').property('disabled',false);
			d3.select('#update_list').on('click',()=>{
				d3.select('#update_list').property('disabled',true);
				show_update_schedule();
				d3.select('#update_list').property('disabled',false);
			});

			// 게이트 데이터 업데이트
			d3.select('#gate_list').property('disabled',false);
			d3.select('#gate_list').on('click',()=>{
				d3.select('#gate_list').property('disabled',true);
				show_gate_num();
				d3.select('#gate_list').property('disabled',false);
			});
		}

    $('document').ready(()=>{
      console.log('ready');
			init_flight_info();
			init_controls();
		});
	</script>
</head>
<body>
<div class="container">
	<% include ./menu.ejs %>
	<div id="controls" class="navbar-form navbar-static-top">
		<label class="control-label">Date</label>
		<input type="date" id="log_date" name="log_date">
		<label class="control-label">Station</label>
		<select id="station" name="station"></select>
		<button id="show_list" disabled=true class="btn btn-primary btn-sm navbar-btn">plan</button>
		<button id="update_list" disabled=true class="btn btn-primary btn-sm navbar-btn">schedule</button>
		<button id="gate_list" disabled=true class="btn btn-primary btn-sm navbar-btn">gate</button>
	</div>
</div>
<!-- <div id="flight_board" class="container-fluid" style="overflow:scroll;height:600px"> -->
<div id="flight_board" class="container-fluid">
	<svg></svg>
</div>
<div id="flight_info" class="info_hidden"></div>
<div id="tooltip_div" class="tooltip" style="opacity: 0;"></div>
<!-- modal -->
<div class="modal fade" id='flt_modal' tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
<div class="modal-dialog">
	<div class="modal-content">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title"><span class="glyphicon glyphicon-star" aria-hidden="true"></span>Flight Detail Infomation!</h4>
		</div>
		<div class="modal-body">
			<div class="form-inline">
					<label>Flight Info: </label>
					<span class="glyphicon glyphicon-send" aria-hidden="true"></span>
					<label id="FlightNumber"></label>
					<label id="Route"></label>
					<span class="glyphicon glyphicon-time" aria-hidden="true"></span>
					<label id="StardardTime"></label>
			</div>
			<table class="table table-bordered">
					<tr class='active'>
							<th>정비 지원</th>
							<th>부서</th><th>메인</th><th>서브</th>
					</tr>
					<tr>
							<td>출발 지원</td>
							<td><select class="form-control input-sm" id="sel_deptD">
								<option>부서</option>
							</select></td>
							<td><select class="form-control input-sm" id="sel_deptDM">
									<option>메인</option>
								</select></td>
							<td><select class="form-control input-sm" id="sel_deptDS">
									<option>서브</option>
								</select></td>
					</tr>
					<tr>
							<td>도착 지원</td>
							<td><select class="form-control input-sm" id="sel_deptA">
									<option>부서</option>
								</select></td>
								<td><select class="form-control input-sm" id="sel_deptAM">
										<option>메인</option>
									</select></td>
								<td><select class="form-control input-sm" id="sel_deptAS">
										<option>서브</option>
									</select></td>
						</tr>
					<tr>
							<td>탑승 지원</td>
							<td><select class="form-control input-sm" id="sel_deptB">
									<option>부서</option>
								</select></td>
								<td><select class="form-control input-sm" id="sel_deptBM">
										<option>메인</option>
									</select></td>
								<td><select class="form-control input-sm" id="sel_deptBS">
									<option>서브</option>
								</select></td>
					</tr>
					<tr>
						<td>주기장</td>
						<td><label for="gate_from">출발</label><input type="text" class="form-control input-sm" id="gate_from" placeholder="출발게이트" readonly></td>
						<td><label for="gate_to">도착</label><input type="text" class="form-control input-sm" id="gate_to" placeholder="도착게이트" readonly></td>
						<td><label for="gate_tmp">토잉</label><input type="text" class="form-control input-sm" id="gate_tmp" placeholder="토잉"></td>
					</tr>
					<tr>
							<td colspan="2">도착후 주요정비</td>
							<td colspan="2">
										<select class="form-control input-sm" id="main_chk">
											<option>DAY CHK</option>
										</select>
							</td>
					</tr>
					<tr>
							<td colspan="4"><label for="comment">Comment</label>
									<textarea class="form-control" id="flt_msg" rows="3"></textarea>
							</td>
						</tr>
				</table>
		</div>
		<div class="modal-footer">
			<button type="button" id='btn_save' class="btn btn-primary">Summit</button>
			<button type="button" id='btn_close' class="btn btn-default" data-dismiss="modal">Cancel</button>
		</div>
	</div><!-- /.modal-content -->
</div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<script>
//event binding
$('#flt_modal #sel_deptD').on("change",()=>{
	set_select(d3.select('#flt_modal').select('#sel_deptDM'),
			filter_emps(recordset,$('#flt_modal #sel_deptD').val()));
	set_select(d3.select('#flt_modal').select('#sel_deptDS'),
			filter_emps(recordset,$('#flt_modal #sel_deptD').val()));
	$('#flt_modal #sel_deptDS').val('');
})
$('#flt_modal #sel_deptA').on("change",()=>{
	set_select(d3.select('#flt_modal').select('#sel_deptAM'),
			filter_emps(recordset,$('#flt_modal #sel_deptA').val()));
	set_select(d3.select('#flt_modal').select('#sel_deptAS'),
			filter_emps(recordset,$('#flt_modal #sel_deptA').val()));
	$('#flt_modal #sel_deptAS').val('');
})
$('#flt_modal #sel_deptB').on("change",()=>{
	set_select(d3.select('#flt_modal').select('#sel_deptBM'),
			filter_emps(recordset,$('#flt_modal #sel_deptB').val()));
	set_select(d3.select('#flt_modal').select('#sel_deptBS'),
			filter_emps(recordset,$('#flt_modal #sel_deptB').val()));
	$('#flt_modal #sel_deptBS').val('')
})

$('#flt_modal #btn_save').on('click',(e)=>{
	console.log('btn_save');
	//console.log(e);
	// 각 정보를 읽어와 처리
	// 1. 작업자
	selected_box.select('#workerA').attr('empcd',$('#flt_modal #sel_deptAM').val()).text($('#flt_modal #sel_deptAM option:selected').text());
	selected_box.select('#workerA').attr('sub_empcd',$('#flt_modal #sel_deptAS').val()).attr('sub_empnm',$('#flt_modal #sel_deptAS option:selected').text());
	selected_box.select('#workerD').attr('empcd',$('#flt_modal #sel_deptDM').val()).text($('#flt_modal #sel_deptDM option:selected').text());
	selected_box.select('#workerD').attr('sub_empcd',$('#flt_modal #sel_deptDS').val()).attr('sub_empnm',$('#flt_modal #sel_deptDS option:selected').text());
	selected_box.select('#workerB').attr('empcd',$('#flt_modal #sel_deptBM').val()).text($('#flt_modal #sel_deptBM option:selected').text());
	selected_box.select('#workerB').attr('sub_empcd',$('#flt_modal #sel_deptBS').val()).attr('sub_empnm',$('#flt_modal #sel_deptDS option:selected').text());
	save_workers(selected_box);

	// 2. 주기장
	var gate_num = $('#flt_modal #gate_tmp').val();
	gate_num = gate_num.trim();
	var gate_txt = gate_num?'('+gate_num+')':''
	//if(gate_num != '')
	{
		selected_box.select('#GateTmp').attr('gate_num',gate_num).text(gate_txt);
		save_gate_tmp(selected_box,gate_num)
	}

	// 3. 주요 정비
	var lov = $('#flt_modal #main_chk option:selected').text()
	show_lov_check(selected_box,lov);
	save_lov_check(selected_box,lov);
	// 4. comment
	var flt_msg = $('#flt_modal #flt_msg').val();
	flt_msg = flt_msg.trim();
	var flt_txt = flt_msg?msg_mark:'';
	//if(flt_msg != '')
	{
		selected_box.attr('msg-tooltip',flt_msg);
		selected_box.select('#flight_msg').attr('flt_msg',flt_msg).text(flt_txt);
		save_descs(selected_box,flt_msg);
	}
	
	// hide modal
	$('#flt_modal').modal('hide');
});
</script>
</body>
<% include ./tail.ejs %>
</html>
